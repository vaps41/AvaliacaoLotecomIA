<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avaliador de Lotes: Eletrónica & Informática</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .card { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06); }
    </style>
</head>
<body>

    <div id="app" class="min-h-screen p-4 sm:p-6 flex flex-col items-center">
        <header class="w-full max-w-2xl text-center mb-6">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Avaliador de Logística Reversa</h1>
            <p class="text-sm text-gray-500 mt-1">Especialista em Eletrónica, Informática e Eletroportáteis.</p>
        </header>

        <!-- Banner de Erro -->
        <div id="error-banner" class="hidden w-full max-w-2xl bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded shadow-md" role="alert">
            <p class="font-bold">⚠️ Erro Detetado:</p>
            <p id="error-text">A iniciar diagnóstico...</p>
            <p class="text-xs mt-2 text-red-600">Dica: Se o erro for "404", verifique se a pasta 'api' está na raiz do projeto.</p>
        </div>

        <!-- Interface Principal -->
        <div class="w-full max-w-2xl bg-white p-6 rounded-xl card mb-6">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Analisar Novo Produto</h2>
            
            <label for="photo-upload" class="flex flex-col items-center justify-center p-6 border-2 border-dashed border-indigo-300 rounded-lg cursor-pointer hover:bg-indigo-50 transition duration-150">
                <svg class="w-8 h-8 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.808-1.212A2 2 0 0110.535 5h2.93a2 2 0 011.664.89l.808 1.212A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                <span id="upload-label" class="mt-2 text-sm text-indigo-600 font-medium text-center">Clique para tirar uma foto AGORA</span>
                <input type="file" id="photo-upload" accept="image/*" class="hidden">
            </label>

            <button id="evaluate-button" class="w-full mt-4 px-4 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150 disabled:bg-indigo-300 flex items-center justify-center space-x-2" disabled>
                <svg id="loading-spinner" class="animate-spin h-5 w-5 text-white hidden" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <span id="evaluation-timer" class="text-white hidden text-sm font-light"></span>
                <span id="button-text">Avaliar Item com IA</span>
            </button>
            <div id="message-area" class="mt-4 text-center"></div>
        </div>

        <div class="w-full max-w-2xl bg-indigo-50 p-6 rounded-xl card mb-6 border border-indigo-200">
            <h2 class="text-xl font-semibold text-indigo-800 mb-2">Valor Total Acumulado</h2>
            <div id="risk-indicator" class="text-lg font-bold"></div>
            <p id="total-value" class="text-4xl font-extrabold text-indigo-600 mt-2">R$ 0,00</p>
            <div class="mt-4 text-sm text-gray-500 flex items-center">
                <span class="mr-2">ID do Utilizador:</span>
                <span id="user-id" class="font-mono text-xs bg-white border border-gray-200 p-1 rounded">A carregar...</span>
            </div>
            <button id="reset-lot" class="mt-4 px-4 py-2 bg-red-500 text-white font-semibold rounded-lg text-sm w-full sm:w-auto">Limpar Lote</button>
        </div>

        <div class="w-full max-w-2xl bg-white p-6 rounded-xl card">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Itens no Lote</h2>
            <ul id="item-list" class="space-y-4"><li id="empty-state" class="text-gray-500 italic text-center p-4">Nenhum item qualificado.</li></ul>
        </div>
    </div>

    <!-- Modal -->
    <div id="custom-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-lg max-w-sm w-full shadow-2xl border-l-4 border-indigo-600">
            <h3 id="modal-title" class="text-lg font-bold text-gray-800 mb-3">Título</h3>
            <p id="modal-content" class="text-gray-600 mb-4">Conteúdo.</p>
            <button id="modal-close" class="w-full px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg">OK</button>
        </div>
    </div>

    <script type="module">
        // USANDO VERSÃO ESTÁVEL 10.12.2
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        let app, db, auth, userId = null, selectedImageBase64 = null;
        let isAuthReady = false, appId = 'default-app-id';
        const LOT_ID = 'current_lot';

        // Elementos
        const evaluateButton = document.getElementById('evaluate-button');
        const uploadLabel = document.getElementById('upload-label');
        const errorBanner = document.getElementById('error-banner');
        const errorText = document.getElementById('error-text');

        function showError(msg) {
            errorBanner.classList.remove('hidden');
            errorText.innerHTML = msg; // Permite HTML para quebras de linha
            console.error(msg);
        }

        function showModal(title, content) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-content').textContent = content;
            document.getElementById('custom-modal').classList.remove('hidden');
        }

        async function initializeFirebase() {
            try {
                // 1. Tenta buscar configurações
                const response = await fetch('/api/config');
                if (response.status === 404) throw new Error("Erro 404: O sistema não encontrou a pasta 'api'.<br>Verifique se os ficheiros 'api/config.js' e 'api/analyze.js' estão na raiz do projeto na Vercel.");
                if (!response.ok) throw new Error(`Erro do Servidor (${response.status}): Verifique os logs da Vercel.`);

                const configData = await response.json();
                
                // 2. Verifica se as chaves existem
                if (!configData.firebaseConfig || !configData.firebaseConfig.apiKey) {
                    throw new Error("Erro de Configuração: As Variáveis de Ambiente estão vazias.<br>Vá à Vercel > Deployments > Redeploy para ativar as chaves.");
                }

                if (configData.appId) appId = configData.appId;

                // 3. Inicializa Firebase
                app = initializeApp(configData.firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await signInAnonymously(auth);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id').textContent = userId;
                        isAuthReady = true;
                        setupRealtimeListener();
                    } else {
                        signInAnonymously(auth).catch(e => showError("Erro Auth: " + e.message));
                    }
                });

            } catch (error) {
                showError(error.message);
            }
        }

        function setupRealtimeListener() {
            if (!isAuthReady || !db) return;
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'auction_lots', LOT_ID), (docSnapshot) => {
                if (docSnapshot.exists()) renderLotData(docSnapshot.data());
                else {
                    const defaultLot = { items: [], totalValue: 0, totalQuantity: 0, totalCategoryRiskSum: 0 };
                    setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'auction_lots', LOT_ID), defaultLot, { merge: true });
                    renderLotData(defaultLot);
                }
            }, (error) => showError("Erro Banco de Dados: " + error.message));
        }

        function renderLotData(data) {
            document.getElementById('total-value').textContent = `R$ ${(data.totalValue || 0).toFixed(2).replace('.', ',')}`;
            const list = document.getElementById('item-list');
            list.innerHTML = '';
            if (!data.items || data.items.length === 0) {
                list.innerHTML = '<li class="text-gray-500 italic text-center p-4">Nenhum item qualificado.</li>';
            } else {
                data.items.slice().reverse().forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'bg-gray-50 p-4 rounded-lg border-l-4 border-indigo-500 shadow-sm mb-2';
                    li.innerHTML = `
                        <div class="flex justify-between font-bold">
                            <span>${item.itemName}</span>
                            <span class="text-indigo-700">R$ ${item['estimatedPriceR$:'].toFixed(2)}</span>
                        </div>
                        <p class="text-sm text-gray-600">${item.condition} - ${item.description}</p>
                        <div class="text-xs text-gray-500 mt-1">Risco: ${item.categoryRiskScore}/10 | Potencial: ${item.resalePotential}</div>
                    `;
                    list.appendChild(li);
                });
            }
        }

        async function compressImage(base64, maxKiloBytes) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width; canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    resolve(canvas.toDataURL('image/jpeg', 0.8)); // Simplificado
                };
                img.src = base64;
            });
        }

        async function callGeminiVision(base64Image) {
            const response = await fetch('/api/analyze', { 
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ image: base64Image }) 
            });
            if (!response.ok) {
                const txt = await response.text();
                throw new Error(txt);
            }
            return response.json();
        }

        document.getElementById('photo-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                uploadLabel.textContent = "A processar...";
                const reader = new FileReader();
                reader.onload = async (ev) => {
                    selectedImageBase64 = await compressImage(ev.target.result, 900);
                    evaluateButton.disabled = false;
                    uploadLabel.textContent = "Foto Pronta: " + file.name;
                };
                reader.readAsDataURL(file);
            }
        });

        evaluateButton.addEventListener('click', async () => {
            if (!selectedImageBase64) return;
            evaluateButton.disabled = true;
            document.getElementById('button-text').textContent = "A analisar...";
            try {
                const data = await callGeminiVision(selectedImageBase64);
                if (data.isInScope === false) {
                    showModal("Fora do Escopo", data.outOfScopeReason);
                } else {
                    // Adicionar ao banco
                    const lotRef = doc(db, 'artifacts', appId, 'public', 'data', 'auction_lots', LOT_ID);
                    await runTransaction(db, async (t) => {
                        const d = (await t.get(lotRef)).data() || {};
                        t.set(lotRef, {
                            items: [...(d.items||[]), data],
                            totalValue: (d.totalValue||0) + data['estimatedPriceR$:'],
                            totalQuantity: (d.totalQuantity||0) + 1,
                            totalCategoryRiskSum: (d.totalCategoryRiskSum||0) + data.categoryRiskScore
                        }, { merge: true });
                    });
                }
            } catch (e) { showModal("Erro", e.message); }
            finally { 
                evaluateButton.disabled = false; 
                document.getElementById('button-text').textContent = "Avaliar Item com IA"; 
            }
        });

        document.getElementById('reset-lot').addEventListener('click', async () => {
            if (confirm("Apagar tudo?")) {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'auction_lots', LOT_ID), { items: [], totalValue: 0, totalQuantity: 0, totalCategoryRiskSum: 0 });
            }
        });

        document.getElementById('modal-close').addEventListener('click', () => document.getElementById('custom-modal').classList.add('hidden'));

        window.onload = initializeFirebase;
    </script>
</body>
</html>
