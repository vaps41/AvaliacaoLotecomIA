<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avaliador de Lotes: Eletr√¥nicos & Inform√°tica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .card { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06); }
    </style>
</head>
<body>

    <div id="app" class="min-h-screen p-4 sm:p-6 flex flex-col items-center">
        <header class="w-full max-w-2xl text-center mb-6">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Avaliador de Log√≠stica Reversa</h1>
            <p class="text-sm text-gray-500 mt-1">Especialista em Eletr√¥nicos, Inform√°tica e Eletroport√°teis.</p>
        </header>

        <!-- Se√ß√£o de Upload e Resultado do Item -->
        <div class="w-full max-w-2xl bg-white p-6 rounded-xl card mb-6">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Analisar Novo Produto</h2>
            
            <!-- Input de Arquivo/C√¢mera -->
            <label for="photo-upload" class="flex flex-col items-center justify-center p-6 border-2 border-dashed border-indigo-300 rounded-lg cursor-pointer hover:bg-indigo-50 transition duration-150">
                <svg class="w-8 h-8 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.808-1.212A2 2 0 0110.535 5h2.93a2 2 0 011.664.89l.808 1.212A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                <span id="upload-label" class="mt-2 text-sm text-indigo-600 font-medium text-center">
                    Clique para tirar uma foto AGORA ou selecionar na galeria
                </span>
                <input type="file" id="photo-upload" accept="image/*" class="hidden">
            </label>

            <!-- BOT√ÉO DE AVALIA√á√ÉO COM SPINNER E CONTADOR -->
            <button id="evaluate-button" class="w-full mt-4 px-4 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 disabled:bg-indigo-300 flex items-center justify-center space-x-2" disabled>
                <svg id="loading-spinner" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span id="evaluation-timer" class="text-white hidden text-sm font-light"></span>
                <span id="button-text" class="">Avaliar Item com IA</span>
            </button>

            <!-- √Årea de Status/Mensagens -->
            <div id="message-area" class="mt-4 text-center"></div>

        </div>

        <!-- Se√ß√£o de Total Acumulado -->
        <div class="w-full max-w-2xl bg-indigo-50 p-6 rounded-xl card mb-6 border border-indigo-200">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-xl font-semibold text-indigo-800">Valor Total Acumulado</h2>
                <div id="risk-indicator" class="text-lg font-bold">
                    <!-- Indicador de Risco -->
                </div>
            </div>
            <div class="mt-2">
                <p id="total-value" class="text-4xl font-extrabold text-indigo-600">R$ 0,00</p>
                <p class="text-sm text-indigo-500">Itens: <span id="total-quantity">0</span> | M√©dia/Item: <span id="avg-unit-value">R$ 0,00</span></p>
                <div class="mt-4 text-sm text-gray-500 flex items-center">
                    <span class="mr-2">ID do Usu√°rio:</span>
                    <span id="user-id" class="font-mono text-xs bg-white border border-gray-200 p-1 rounded">Carregando...</span>
                    <button id="copy-user-id" class="text-indigo-600 hover:text-indigo-800 ml-2 text-xs font-bold" title="Copiar ID">
                        COPIAR
                    </button>
                </div>
            </div>
            <button id="reset-lot" class="mt-4 px-4 py-2 bg-red-500 text-white font-semibold rounded-lg text-sm hover:bg-red-600 transition duration-150 w-full sm:w-auto">
                Limpar Lote (Zerar Valor)
            </button>
        </div>

        <!-- Lista de Itens Avaliados -->
        <div class="w-full max-w-2xl bg-white p-6 rounded-xl card">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Itens no Lote</h2>
            <ul id="item-list" class="space-y-4">
                <li id="empty-state" class="text-gray-500 italic text-center p-4">Nenhum item qualificado no lote.</li>
            </ul>
        </div>
    </div>

    <!-- Modal de Mensagem Personalizada -->
    <div id="custom-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-lg max-w-sm w-full shadow-2xl border-l-4 border-indigo-600">
            <h3 id="modal-title" class="text-lg font-bold text-gray-800 mb-3">T√≠tulo</h3>
            <p id="modal-content" class="text-gray-600 mb-4">Conte√∫do da mensagem.</p>
            <button id="modal-close" class="w-full px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700">OK</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, collection, query, where, getDocs, setLogLevel, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Vari√°veis de Ambiente
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const apiKey = ""; // API Key injetada pelo ambiente
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        const LOT_ID = 'current_lot'; 

        // Refer√™ncias Globais
        let app, db, auth, userId = null;
        let selectedImageBase64 = null;
        let isAuthReady = false;

        // Elementos DOM
        const evaluateButton = document.getElementById('evaluate-button');
        const uploadLabel = document.getElementById('upload-label');
        const photoUpload = document.getElementById('photo-upload');
        const loadingSpinner = document.getElementById('loading-spinner');
        const buttonText = document.getElementById('button-text');
        const evaluationTimer = document.getElementById('evaluation-timer');
        
        // Timer
        let timerIntervalId = null;
        const TIMEOUT_SECONDS = 30;

        // --- Prompt do Sistema (REGRAS ESTRITAS) ---
        const SYSTEM_PROMPT = `
üéØ Papel da IA:
Voc√™ √© uma IA especialista em avalia√ß√£o, precifica√ß√£o e an√°lise de risco de produtos de log√≠stica reversa, com foco exclusivo em: Eletr√¥nicos Port√°teis, Inform√°tica, Eletr√¥nicos Dom√©sticos e Eletrodom√©sticos Pequenos.

üîí ESCOPO FIXO (N√ÉO SAIR DISSO):
Analise APENAS: Celulares, Tablets, Smartwatches, Fones, Notebooks, Desktops, Monitores, Componentes, TVs, Projetores, Som, Cafeteiras, Airfryers, Micro-ondas, Aspiradores, Ventiladores, Ferros.

‚ùå PROIBIDO:
Ve√≠culos, M√°quinas industriais, Ferramentas pesadas, M√≥veis, Im√≥veis, Eletrodom√©sticos grandes (geladeira, fog√£o).

‚ö†Ô∏è REGRA DE REJEI√á√ÉO:
Se o produto estiver fora do escopo, defina o campo JSON "isInScope" como false e "outOfScopeReason" como "Produto fora do escopo de an√°lise.". N√ÉO estime pre√ßo.

üìä Crit√©rios de An√°lise:
1. Identifique o item e categoria.
2. Estado f√≠sico (Novo, Usado, Defeito, Sucata).
3. Valor de Mercado (Estimativa conservadora).
4. Risco da Categoria (1=Baixo a 10=Alto).
5. Pre√ßo M√°ximo para Leil√£o (Lance recomendado).
6. Potencial de Revenda (Venda direta, Reparo, Pe√ßas).

Sua resposta DEVE ser um objeto JSON v√°lido seguindo estritamente o schema solicitado.
`;

        // --- Fun√ß√µes de UI ---

        function showModal(title, content) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-content').textContent = content;
            document.getElementById('custom-modal').classList.remove('hidden');
        }

        function setButtonState(isLoading, text) {
            evaluateButton.disabled = isLoading;
            loadingSpinner.classList.toggle('hidden', !isLoading);
            buttonText.classList.toggle('hidden', isLoading);
            
            if (!isLoading) {
                buttonText.textContent = text;
                evaluateButton.disabled = !selectedImageBase64;
            }
        }
        
        function startTimer() {
            clearTimer();
            let timeLeft = TIMEOUT_SECONDS;
            evaluationTimer.classList.remove('hidden');
            evaluationTimer.textContent = `(0:${timeLeft.toString().padStart(2, '0')}s)`;

            timerIntervalId = setInterval(() => {
                timeLeft--;
                if (timeLeft <= 0) {
                    clearTimer();
                    evaluationTimer.textContent = `(0:00s)`;
                } else {
                    evaluationTimer.textContent = `(0:${timeLeft.toString().padStart(2, '0')}s)`;
                }
                if (timeLeft <= 10) evaluationTimer.classList.add('text-red-300');
            }, 1000);
        }

        function clearTimer() {
            if (timerIntervalId !== null) {
                clearInterval(timerIntervalId);
                timerIntervalId = null;
            }
            evaluationTimer.classList.add('hidden');
            evaluationTimer.classList.remove('text-red-300');
            evaluationTimer.textContent = '';
        }

        function displayMessage(message, type) {
            const messageArea = document.getElementById('message-area');
            let color = '';
            switch (type) {
                case 'success': color = 'text-green-600 bg-green-100'; break;
                case 'error': color = 'text-red-600 bg-red-100'; break;
                case 'info': color = 'text-blue-600 bg-blue-100'; break;
                default: color = 'text-gray-600 bg-gray-100'; break;
            }
            messageArea.innerHTML = `<p class="p-2 rounded ${color}">${message}</p>`;
            setTimeout(() => { messageArea.innerHTML = ''; }, 5000);
        }
        
        function compressImage(base64Image, maxKiloBytes) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0, img.width, img.height);
                    let compressedImage = base64Image;
                    let currentQuality = 0.9;
                    const maxBytes = maxKiloBytes * 1024;
                    const minQuality = 0.4;
                    while (compressedImage.length > maxBytes && currentQuality > minQuality) {
                        currentQuality -= 0.1;
                        compressedImage = canvas.toDataURL('image/jpeg', currentQuality);
                    }
                    if (compressedImage.length > maxBytes) {
                        const ratio = Math.sqrt(maxBytes / compressedImage.length);
                        canvas.width = img.width * ratio;
                        canvas.height = img.height * ratio;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        compressedImage = canvas.toDataURL('image/jpeg', 0.9);
                    }
                    resolve(compressedImage);
                };
                img.onerror = () => resolve(base64Image);
                img.src = base64Image;
            });
        }
        
        function calculateLotRisk(lotData) {
            const { totalValue, totalQuantity, totalCategoryRiskSum } = lotData;
            if (totalQuantity === 0) return { riskLevel: 'N/A', indicator: '‚ö™Ô∏è', color: 'text-gray-400', overallRiskScore: 0 };

            const AUV = totalValue / totalQuantity;
            let auvScore; 
            if (AUV < 300) auvScore = 2; 
            else if (AUV < 2000) auvScore = 5; 
            else auvScore = 9; 

            const AvgCR = totalCategoryRiskSum / totalQuantity; 
            let volumeScore = totalQuantity < 5 ? 2 : (totalQuantity < 15 ? 5 : 8);
            
            const overallRiskScore = (AvgCR * 0.5) + (auvScore * 0.3) + (volumeScore * 0.2);

            let riskLevel, indicator, color;
            if (overallRiskScore < 4.0) { riskLevel = 'Baixo Risco'; indicator = 'üü¢'; color = 'text-green-600'; }
            else if (overallRiskScore < 7.5) { riskLevel = 'M√©dio Risco'; indicator = 'üü°'; color = 'text-yellow-600'; }
            else { riskLevel = 'Alto Risco'; indicator = 'üî¥'; color = 'text-red-600'; }
            
            return { riskLevel, indicator, color, overallRiskScore: overallRiskScore.toFixed(1) };
        }

        // --- Firebase ---

        async function initializeFirebase() {
            try {
                setLogLevel('silent'); // Limpa logs para produ√ß√£o
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                else await signInAnonymously(auth);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id').textContent = userId;
                        isAuthReady = true;
                        setupLotDocument();
                        setupRealtimeListener();
                    } else if (!initialAuthToken) {
                         signInAnonymously(auth).catch(e => console.error(e));
                    }
                });
            } catch (error) {
                console.error("Firebase Init Error:", error);
                showModal("Erro Cr√≠tico", "Falha na conex√£o de dados.");
            }
        }

        function getLotDocRef() {
            return doc(db, 'artifacts', appId, 'public', 'data', 'auction_lots', LOT_ID);
        }

        async function setupLotDocument() {
            if (!db || !userId) return;
            const lotRef = getLotDocRef();
            const defaultLot = {
                items: [], totalValue: 0, totalQuantity: 0, totalCategoryRiskSum: 0,
                lastUpdated: new Date().toISOString(), creatorId: userId
            };
            try { await setDoc(lotRef, defaultLot, { merge: true }); } catch (e) { console.error(e); }
        }

        function setupRealtimeListener() {
            if (!isAuthReady || !db) return;
            onSnapshot(getLotDocRef(), (docSnapshot) => {
                if (docSnapshot.exists()) renderLotData(docSnapshot.data());
                else { setupLotDocument(); renderLotData({ items: [], totalValue: 0, totalQuantity: 0, totalCategoryRiskSum: 0 }); }
            }, (error) => console.error("Snapshot error:", error));
        }

        function renderLotData(data) {
            const totalValueElement = document.getElementById('total-value');
            const itemListElement = document.getElementById('item-list');
            const emptyState = document.getElementById('empty-state');
            const totalQuantityElement = document.getElementById('total-quantity');
            const avgUnitValueElement = document.getElementById('avg-unit-value');
            const riskIndicatorElement = document.getElementById('risk-indicator');

            const total = data.totalValue || 0;
            const items = data.items || [];
            const quantity = data.totalQuantity || 0;
            const risk = calculateLotRisk(data);
            const avgUnitValue = quantity > 0 ? total / quantity : 0;

            totalValueElement.textContent = `R$ ${total.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.')}`;
            totalQuantityElement.textContent = quantity;
            avgUnitValueElement.textContent = `R$ ${avgUnitValue.toFixed(2).replace('.', ',')}`;
            riskIndicatorElement.innerHTML = `<span class="${risk.color} text-3xl mr-1 align-middle">${risk.indicator}</span><span class="text-gray-800 text-sm font-bold align-middle">${risk.riskLevel}</span>`;

            itemListElement.innerHTML = '';
            if (items.length === 0) {
                emptyState.classList.remove('hidden');
                itemListElement.appendChild(emptyState);
            } else {
                emptyState.classList.add('hidden');
                items.slice().reverse().forEach((item) => {
                    const listItem = document.createElement('li');
                    listItem.className = 'flex flex-col sm:flex-row items-start bg-gray-50 p-4 rounded-lg border-l-4 border-indigo-500 shadow-sm transition hover:shadow-md';
                    listItem.innerHTML = `
                        <div class="sm:w-28 sm:h-28 flex-shrink-0 mb-4 sm:mb-0 sm:mr-4">
                            ${item.photo ? `<img src="${item.photo}" alt="${item.itemName}" class="w-full h-full object-cover rounded-lg shadow-md border border-gray-200">` : `<div class="w-full h-full bg-gray-200 rounded-lg flex items-center justify-center text-xs text-gray-500">Sem Imagem</div>`}
                        </div>
                        <div class="flex-grow w-full">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="text-lg font-bold text-gray-800">${item.itemName}</h3>
                                    <span class="inline-block bg-indigo-100 text-indigo-800 text-xs px-2 py-0.5 rounded-full mb-2 font-medium">${item.itemCategory}</span>
                                </div>
                                <div class="text-right">
                                    <p class="text-lg font-bold text-indigo-700">R$ ${item['estimatedPriceR$:'].toFixed(2).replace('.', ',')}</p>
                                    <p class="text-xs text-gray-500">Lance M√°x: R$ ${item.maxBidRecommendationR$ ? item.maxBidRecommendationR$.toFixed(2).replace('.', ',') : '---'}</p>
                                </div>
                            </div>
                            
                            <p class="text-sm text-gray-700 mt-1 leading-snug"><strong>Estado:</strong> ${item.condition || 'N/A'} - ${item.description}</p>
                            
                            <div class="mt-3 grid grid-cols-2 gap-2 text-xs text-gray-600 bg-white p-2 rounded border border-gray-100">
                                <div>
                                    <span class="font-semibold text-gray-500">Potencial:</span><br>
                                    ${item.resalePotential || 'N√£o analisado'}
                                </div>
                                <div class="text-right">
                                    <span class="font-semibold text-gray-500">Risco Categoria:</span><br>
                                    <span class="${item.categoryRiskScore > 7 ? 'text-red-500 font-bold' : (item.categoryRiskScore < 4 ? 'text-green-500 font-bold' : 'text-yellow-600 font-bold')}">${item.categoryRiskScore}/10</span>
                                </div>
                            </div>
                        </div>
                    `;
                    itemListElement.appendChild(listItem);
                });
            }
        }

        async function addItemToLot(newItemData, imageBase64) {
            if (!isAuthReady || !db) { showModal("Conex√£o", "Aguarde a conex√£o com o banco."); return; }
            setButtonState(true, "Salvando...");
            try {
                const lotRef = getLotDocRef();
                await runTransaction(db, async (transaction) => {
                    const lotDoc = await transaction.get(lotRef);
                    let data = lotDoc.exists() ? lotDoc.data() : {};
                    
                    const updatedItems = [...(data.items || []), { ...newItemData, photo: imageBase64 }];
                    const updatedTotal = (data.totalValue || 0) + newItemData['estimatedPriceR$:'];
                    const updatedQuantity = (data.totalQuantity || 0) + 1;
                    const updatedRiskSum = (data.totalCategoryRiskSum || 0) + newItemData.categoryRiskScore;

                    transaction.set(lotRef, {
                        items: updatedItems, totalValue: updatedTotal, totalQuantity: updatedQuantity,
                        totalCategoryRiskSum: updatedRiskSum, lastUpdated: new Date().toISOString(), creatorId: userId
                    }, { merge: true });
                });
                displayMessage(`Item adicionado: ${newItemData.itemName}`, 'success');
            } catch (error) {
                console.error("Erro Persist√™ncia:", error);
                throw new Error("Erro ao salvar dados. Tente novamente.");
            }
        }
        
        // --- API Gemini ---
        async function exponentialBackoff(fn, retries = 5, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try { return await fn(); } catch (e) { if (i === retries - 1) throw e; await new Promise(r => setTimeout(r, delay * (2 ** i))); }
            }
        }

        async function callGeminiVision(base64Image) {
            if (!base64Image) return null;
            const [header, data] = base64Image.split(',');
            const mimeType = header.match(/data:(.*?);/)[1];
            
            const userQuery = "Analise este item. Responda APENAS com o JSON.";

            const payload = {
                contents: [{ role: "user", parts: [{ text: userQuery }, { inlineData: { mimeType: mimeType, data: data } }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "isInScope": { "type": "BOOLEAN", "description": "True se for eletr√¥nico/eletrodom√©stico pequeno. False se for m√≥vel, roupa, carro, etc." },
                            "outOfScopeReason": { "type": "STRING", "description": "Se n√£o estiver no escopo, explique brevemente o motivo." },
                            "itemName": { "type": "STRING", "description": "Nome curto do produto (Marca/Modelo)." },
                            "description": { "type": "STRING", "description": "Resumo do estado e observa√ß√µes." },
                            "condition": { "type": "STRING", "description": "Ex: Novo, Usado, Sucata." },
                            "estimatedPriceR$:": { "type": "NUMBER", "description": "Valor de mercado unit√°rio." },
                            "maxBidRecommendationR$": { "type": "NUMBER", "description": "Pre√ßo m√°ximo recomendado para lance em leil√£o." },
                            "itemCategory": { "type": "STRING", "description": "Categoria principal." },
                            "categoryRiskScore": { "type": "NUMBER", "description": "Risco de 1 a 10." },
                            "resalePotential": { "type": "STRING", "description": "Venda direta, Reparo ou Pe√ßas." }
                        },
                        required: ["isInScope", "itemName", "description", "condition", "estimatedPriceR$:", "itemCategory", "categoryRiskScore", "maxBidRecommendationR$", "resalePotential"]
                    }
                },
                systemInstruction: { parts: [{ text: SYSTEM_PROMPT }] }
            };
            
            const fetchFn = async () => {
                const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                return response.json();
            };

            const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error("AI_TIMEOUT")), 30000));

            try {
                const result = await Promise.race([exponentialBackoff(fetchFn), timeoutPromise]);
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (jsonText) return JSON.parse(jsonText);
                throw new Error("Resposta inv√°lida da IA.");
            } catch (error) { throw error; }
        }

        // --- Eventos ---
        photoUpload.addEventListener('change', function(event) {
            const file = event.target.files[0];
            selectedImageBase64 = null;
            evaluateButton.disabled = true;
            uploadLabel.textContent = 'Clique para tirar uma foto AGORA ou selecionar na galeria';

            if (file) {
                if (!file.type.startsWith('image/')) { showModal("Erro", "Arquivo inv√°lido."); return; }
                const reader = new FileReader();
                reader.onload = async function(e) {
                    setButtonState(true, "Processando...");
                    try {
                        selectedImageBase64 = await compressImage(e.target.result, 900);
                        const sizeInKB = Math.round(selectedImageBase64.length / 1024);
                        evaluateButton.disabled = false;
                        uploadLabel.textContent = `Foto pronta: ${file.name} (${sizeInKB} KB)`;
                    } catch (err) { console.error(err); } finally { setButtonState(false, "Avaliar Item com IA"); }
                };
                reader.readAsDataURL(file);
            }
        });

        evaluateButton.addEventListener('click', async () => {
            if (!selectedImageBase64) return;
            setButtonState(true, "Analisando...");
            document.getElementById('message-area').innerHTML = ''; 
            startTimer();

            try {
                const itemData = await callGeminiVision(selectedImageBase64);
                
                // üõë VERIFICA√á√ÉO DE ESCOPO (REGRA DE OURO)
                if (itemData.isInScope === false) {
                    showModal("Produto N√£o Qualificado", itemData.outOfScopeReason || "Este produto n√£o pertence √†s categorias de eletr√¥nicos ou inform√°tica permitidas.");
                    // N√£o salva, n√£o adiciona.
                    return; 
                }

                // Normaliza√ß√£o dos dados num√©ricos
                itemData['estimatedPriceR$:'] = parseFloat(itemData['estimatedPriceR$:']?.toFixed(2) || 0);
                itemData.maxBidRecommendationR$ = parseFloat(itemData.maxBidRecommendationR$?.toFixed(2) || 0);
                itemData.categoryRiskScore = Math.min(10, Math.max(1, Math.round(itemData.categoryRiskScore || 5)));
                
                await addItemToLot(itemData, selectedImageBase64);

            } catch (error) {
                console.error("Erro:", error);
                let msg = error.message;
                if (msg.includes("AI_TIMEOUT")) msg = "Tempo esgotado (30s). A imagem pode estar muito complexa ou a conex√£o lenta. Tente novamente.";
                showModal("Aten√ß√£o", msg);
            } finally {
                clearTimer();
                setButtonState(false, "Avaliar Item com IA");
                selectedImageBase64 = null;
                photoUpload.value = '';
                uploadLabel.textContent = 'Clique para tirar uma foto AGORA ou selecionar na galeria';
            }
        });

        document.getElementById('reset-lot').addEventListener('click', () => {
             showModal("Limpar Lote", "Deseja realmente apagar todos os itens?");
             const btn = document.getElementById('modal-close');
             btn.textContent = 'Confirmar Limpeza';
             btn.onclick = async () => {
                document.getElementById('custom-modal').classList.add('hidden'); 
                if (!isAuthReady) return;
                try {
                    setButtonState(true, "Limpando...");
                    await setDoc(getLotDocRef(), { items: [], totalValue: 0, totalQuantity: 0, totalCategoryRiskSum: 0, lastUpdated: new Date().toISOString(), creatorId: userId });
                    displayMessage("Lote reiniciado.", 'info');
                } catch (e) { console.error(e); } finally { 
                    btn.textContent = 'OK';
                    btn.onclick = () => document.getElementById('custom-modal').classList.add('hidden');
                    setButtonState(false, "Avaliar Item com IA"); 
                }
             };
        });

        document.getElementById('modal-close').addEventListener('click', function() {
            this.textContent = 'OK';
            document.getElementById('custom-modal').classList.add('hidden');
        });

        document.getElementById('copy-user-id').addEventListener('click', () => {
            const txt = document.getElementById('user-id').textContent;
            navigator.clipboard.writeText(txt).then(() => displayMessage("ID Copiado", 'success')).catch(() => {});
        });

        window.onload = () => { initializeFirebase(); evaluateButton.disabled = true; };
    </script>
</body>

</html>
